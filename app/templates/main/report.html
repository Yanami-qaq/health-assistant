<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>å¥åº·è¯„ä¼°æŠ¥å‘Š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #525659; font-family: 'Segoe UI', sans-serif; padding: 20px; }

        /* === çº¸å¼ æ¨¡æ‹Ÿ (å“åº”å¼ä¼˜åŒ–) === */
        .a4-page {
            background: white;
            /* æ‰‹æœº/ç”µè„‘å±å¹•ä¸Šï¼šè‡ªé€‚åº”å®½åº¦ï¼Œæœ€å¤§ä¸è¶…è¿‡ A4 å®½åº¦ */
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        /* ğŸ“± æ‰‹æœºç«¯å¾®è°ƒ */
        @media (max-width: 768px) {
            body { padding: 0; background-color: white; }
            .a4-page {
                box-shadow: none;
                padding: 15px;
                max-width: 100%;
                min-height: auto; /* æ‰‹æœºä¸Šä¸éœ€è¦å¼ºåˆ¶é«˜åº¦ */
            }
            .fab-download { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 20px; }
            .report-title { font-size: 20px; }
        }

        /* ğŸ–¨ï¸ æ‰“å°/ç”ŸæˆPDFä¸“ç”¨æ ·å¼ */
        @media print {
            body { background-color: white; padding: 0; }
            .a4-page {
                width: 210mm;
                height: 297mm;
                padding: 20mm;
                box-shadow: none;
                margin: 0;
            }
            .fab-download { display: none !important; }
        }

        .report-header { border-bottom: 3px solid #11998e; padding-bottom: 20px; margin-bottom: 30px; }
        .report-title { font-size: 24px; font-weight: bold; color: #333; }
        .report-meta { color: #666; font-size: 14px; text-align: right; }

        .section-title {
            font-size: 16px; font-weight: bold; color: #11998e;
            border-left: 4px solid #11998e; padding-left: 10px; margin: 30px 0 15px 0;
            background-color: #f8f9fa; padding-top: 5px; padding-bottom: 5px;
        }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center; }
        /* æ‰‹æœºä¸Šæ”¹ä¸º 2 åˆ— */
        @media (max-width: 576px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }

        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: bold; color: #333; margin-top: 5px; }

        .fab-download {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #11998e; color: white; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; z-index: 999;
        }
        .fab-download:hover { transform: scale(1.1); background: #0e8076; }
    </style>
</head>
<body>

<button class="fab-download" onclick="downloadPDF()" title="ä¸‹è½½ PDF">
    <i class="bi bi-file-earmark-pdf"></i>
</button>

<div class="a4-page" id="report-content">

    <div class="report-header d-flex justify-content-between align-items-end">
        <div>
            <div class="text-uppercase text-muted small fw-bold ls-1">Health Assistant</div>
            <div class="report-title">ä¸ªäººå¥åº·è¯„ä¼°æŠ¥å‘Š</div>
        </div>
        <div class="report-meta">
            <div>ç”¨æˆ·ï¼š{{ user.nickname }}</div>
            <div>ç”Ÿæˆæ—¥æœŸï¼š{{ generate_date }}</div>
            <div class="badge bg-primary mt-1">æœˆåº¦æ€»ç»“</div>
        </div>
    </div>

    <div class="section-title">æ ¸å¿ƒä½“å¾æ¦‚è§ˆ</div>
    <div class="stat-grid">
        <div class="stat-item">
            <div class="stat-label">BMI æŒ‡æ•°</div>
            <div class="stat-value text-primary">{{ bmi }}</div>
            <div class="small text-{{ 'success' if bmi_status=='æ­£å¸¸' else 'warning' }}">{{ bmi_status }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">æœ€æ–°ä½“é‡</div>
            <div class="stat-value">{{ last_rec.weight }} <span class="small fw-normal">kg</span></div>
            <div class="small text-muted">æœˆå‡ {{ avg_weight }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">ä½“è„‚ç‡</div>
            <div class="stat-value">{{ last_rec.body_fat or '--' }} <span class="small fw-normal">%</span></div>
            <div class="small text-muted">èº«ä½“æˆåˆ†</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">æ—¥å‡æ­¥æ•°</div>
            <div class="stat-value">{{ avg_steps }}</div>
            <div class="small text-muted">æ´»è·ƒåº¦</div>
        </div>
    </div>

    <div class="section-title">è¿‘ 30 å¤©æ•°æ®è¶‹åŠ¿</div>
    <div style="height: 250px; width: 100%; margin-bottom: 20px;">
        {% if dates %}
            <canvas id="trendChart"></canvas>
        {% else %}
            <div class="h-100 d-flex align-items-center justify-content-center bg-light rounded text-muted">
                <i class="bi bi-bar-chart me-2"></i> æš‚æ— è¶³å¤Ÿæ•°æ®ç”Ÿæˆå›¾è¡¨
            </div>
        {% endif %}
    </div>

    <div class="section-title">è¿‘æœŸä½“æ£€æ•°æ® (æœ€è¿‘ 5 æ¬¡)</div>
    <table class="table table-sm table-striped small" style="font-size: 0.9rem;">
        <thead class="table-light"><tr><th>æ—¥æœŸ</th><th>ä½“é‡</th><th>ä½“è„‚%</th><th>è¡€ç³–</th><th>è¡€å‹</th><th>ç¡çœ </th></tr></thead>
        <tbody>
            {# ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨å¾ªç¯é€»è¾‘ï¼Œé˜²æ­¢æ•°æ®å°‘äº 5 æ¡æ—¶æŠ¥é”™ #}
            {% if dates %}
                {# è®¡ç®—å®é™…éœ€è¦å¾ªç¯çš„æ¬¡æ•°ï¼Œæœ€å¤š 5 æ¬¡ #}
                {% set count = dates|length if dates|length < 5 else 5 %}
                {% for i in range(count) %}
                <tr>
                    {# ä½¿ç”¨å€’åºç´¢å¼•å–æœ€æ–°çš„æ•°æ® #}
                    <td>{{ dates[-(i+1)] }}</td>
                    <td>{{ weights[-(i+1)] }} kg</td>
                    <td>--</td> {# æš‚æ— å­—æ®µ #}
                    <td>--</td> {# æš‚æ— å­—æ®µ #}
                    <td>--</td> {# æš‚æ— å­—æ®µ #}
                    <td>-- h</td> {# æš‚æ— å­—æ®µ #}
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="6" class="text-center text-muted p-3">æš‚æ— è®°å½•</td></tr>
            {% endif %}
        </tbody>
    </table>
    <div class="text-center small text-muted fst-italic">*ä»…å±•ç¤ºéƒ¨åˆ†å…³é”®æ•°æ®ï¼Œå®Œæ•´è®°å½•è¯·æŸ¥é˜… APPã€‚</div>

    <div class="section-title">AI å¥åº·æŒ‡å¯¼å»ºè®®</div>
    <div class="p-3 bg-light rounded border">
        {% if latest_plan %}
            <h6 class="fw-bold">{{ latest_plan.goal }}</h6>
            <div id="ai-content" class="small text-secondary" style="line-height: 1.6;">{{ latest_plan.content }}</div>
        {% else %}
            <p class="text-muted text-center my-3">æš‚æ—  AI å»ºè®®ï¼Œè¯·å…ˆä½¿ç”¨â€œAI é¡¾é—®â€åŠŸèƒ½ã€‚</p>
        {% endif %}
    </div>

    <div class="mt-5 pt-3 border-top text-center text-muted" style="font-size: 10px;">
        <p>æœ¬æŠ¥å‘Šç”± Health Assistant AI ç”Ÿæˆï¼Œä»…ä¾›å¥åº·å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚</p>
        <p>Generated at {{ generate_date }} | Page 1 of 1</p>
    </div>
</div>

<script>
    // 1. æ¸²æŸ“å›¾è¡¨ (ä»…å½“æœ‰æ•°æ®æ—¶)
    {% if dates %}
    const ctx = document.getElementById('trendChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates | tojson }},
            datasets: [
                { label: 'ä½“é‡ (kg)', data: {{ weights | tojson }}, borderColor: '#11998e', tension: 0.4 },
                { label: 'æ­¥æ•°', data: {{ steps | tojson }}, borderColor: '#38ef7d', yAxisID: 'y1', borderDash: [5,5], tension: 0.4 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { display: true, position: 'left' },
                y1: { display: true, position: 'right', grid: { display: false } }
            },
            plugins: { legend: { position: 'top' } }
        }
    });
    {% endif %}

    // 2. æ¸²æŸ“ Markdown
    document.addEventListener('DOMContentLoaded', () => {
        const aiDiv = document.getElementById('ai-content');
        if(aiDiv && typeof marked !== 'undefined') {
            aiDiv.innerHTML = marked.parse(aiDiv.textContent);
        }
    });

    // 3. PDF ä¸‹è½½åŠŸèƒ½
    function downloadPDF() {
        const element = document.getElementById('report-content');
        const opt = {
            margin:       0,
            filename:     'Health_Report_{{ user.nickname }}.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 }, // 2å€ç¼©æ”¾ï¼Œæ¸…æ™°åº¦æ›´é«˜
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // éšè—ä¸‹è½½æŒ‰é’®é˜²æ­¢è¢«æˆªå±è¿›å»
        const btn = document.querySelector('.fab-download');
        btn.style.display = 'none';

        html2pdf().set(opt).from(element).save().then(() => {
            // ä¸‹è½½å®Œæˆåæ¢å¤æŒ‰é’®
            btn.style.display = 'flex';
        });
    }
</script>

</body>
</html>