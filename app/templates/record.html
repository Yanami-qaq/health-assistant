<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ¯æ—¥å¥åº·æ‰“å¡ - å¥åº·åŠ©æ‰‹ 2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4 shadow-sm">
    <div class="container">
        <span class="navbar-brand mb-0 h1 fw-bold">Health Assistant 2.0</span>
        
        <div class="d-flex align-items-center">
            <a href="/dashboard" class="btn btn-outline-light btn-sm me-2">ğŸ  è¿”å›é¦–é¡µ</a>
            <a href="/plan" class="btn btn-warning btn-sm me-2 text-dark fw-bold">âœ¨ AI é¡¾é—®</a>
            <a href="/community" class="btn btn-info btn-sm me-3 text-white fw-bold">ğŸ’¬ ç¤¾åŒº</a>

            <span class="text-white me-2">ä½ å¥½ï¼Œ{{ nickname }}</span>
            <a href="/settings" class="btn btn-sm btn-outline-light me-2" title="ä¸ªäººè®¾ç½®">âš™ï¸</a>
            <a href="/logout" class="btn btn-sm btn-danger">é€€å‡º</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-9">
            
            <div class="card shadow mb-5">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success">ğŸ“ è®°å½•ä»Šæ—¥æ•°æ®</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="syncDeviceData()">
                        <i class="bi bi-watch"></i> æ¨¡æ‹Ÿä»å¥åº·Appå¯¼å…¥
                    </button>
                </div>
                <div class="card-body">
                    <form method="POST">
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">ä½“é‡ (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="weight" name="weight" placeholder="0.0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">æ­¥æ•°</label>
                                <input type="number" class="form-control" id="steps" name="steps" placeholder="0" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">ç¡çœ æ—¶é•¿ (h)</label>
                                <input type="number" step="0.1" class="form-control" id="sleep_hours" name="sleep_hours" placeholder="ä¾‹å¦‚: 7.5" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">é™æ¯å¿ƒç‡ (bpm)</label>
                                <input type="number" class="form-control" id="heart_rate" name="heart_rate" placeholder="ä¾‹å¦‚: 72" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">æ¶ˆè€—å¡è·¯é‡Œ</label>
                                <input type="number" class="form-control" id="calories" name="calories" placeholder="0" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">æ”¶ç¼©å‹ (é«˜å‹ mmHg)</label>
                                <input type="number" class="form-control" id="blood_pressure_high" name="bp_high" placeholder="120" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">èˆ’å¼ å‹ (ä½å‹ mmHg)</label>
                                <input type="number" class="form-control" id="blood_pressure_low" name="bp_low" placeholder="80" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">èº«ä½“æ„Ÿè§‰ / å¤‡æ³¨</label>
                            <input type="text" class="form-control" id="note" name="note" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©çŠ¶æ€ä¸é”™ï¼Œæ„Ÿè§‰ç²¾åŠ›å……æ²›...">
                        </div>

                        <button type="submit" class="btn btn-success w-100 fw-bold py-2">ğŸ’¾ ä¿å­˜å…¨éƒ¨æ•°æ®</button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0">ğŸ“Š å†å²è®°å½•æ¡£æ¡ˆ</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 text-center align-middle">
                            <thead class="table-success text-nowrap">
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>ä½“é‡</th>
                                    <th>æ­¥æ•°</th>
                                    <th>ç¡çœ </th>
                                    <th>å¿ƒç‡/è¡€å‹</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td class="fw-bold">{{ record.date }}</td>
                                    <td>{{ record.weight }}</td>
                                    <td>{{ record.steps }}</td>
                                    <td>{{ record.sleep_hours or '-' }}h</td>
                                    <td>
                                        {% if record.heart_rate %}
                                            <span class="badge bg-info text-dark">{{ record.heart_rate }}</span>
                                        {% endif %}
                                        <br>
                                        {% if record.blood_pressure_high %}
                                            <small class="text-muted">{{ record.blood_pressure_high }}/{{ record.blood_pressure_low }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-start text-muted small" style="max-width: 150px;">{{ record.note }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        è¿˜æ²¡æœ‰è®°å½•å“¦ï¼Œå¿«å»ä¸Šæ–¹æ·»åŠ ç¬¬ä¸€æ¡å®Œæ•´æ•°æ®å§ï¼
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function syncDeviceData() {
    // 1. è·å–æŒ‰é’®å…ƒç´ ï¼Œæ”¹å˜çŠ¶æ€
    const btn = document.querySelector('button[onclick="syncDeviceData()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> åŒæ­¥ä¸­...';
    btn.disabled = true;

    // 2. è°ƒç”¨åç«¯æ¥å£
    fetch('/api/simulate_import')
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                const data = result.data;
                
                // === æ–°å¢ï¼šè‡ªåŠ¨è·å–å½“å‰æ—¥æœŸå¹¶å¡«å…… (æ ¼å¼ YYYY-MM-DD) ===
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                // å¡«å……æ—¥æœŸ
                const dateInput = document.getElementById('date');
                if(dateInput) dateInput.value = todayStr;

                // 3. è‡ªåŠ¨å¡«å……å…¶ä»–è¡¨å•å­—æ®µ
                document.getElementById('weight').value = data.weight;
                document.getElementById('steps').value = data.steps;
                document.getElementById('calories').value = data.calories;
                document.getElementById('sleep_hours').value = data.sleep_hours;
                document.getElementById('heart_rate').value = data.heart_rate;
                document.getElementById('blood_pressure_high').value = data.bp_high;
                document.getElementById('blood_pressure_low').value = data.bp_low;
                document.getElementById('note').value = data.note;

                // 4. æˆåŠŸæç¤º
                alert(result.message);
            } else {
                alert('åŒæ­¥å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('è¿æ¥è®¾å¤‡æ¥å£å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åå°æœåŠ¡');
        })
        .finally(() => {
            // 5. æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}
</script>

</body>
</html>