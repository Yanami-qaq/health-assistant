<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>è®°å½•æ•°æ® - Health Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        body { background-color: #f0f2f5; font-family: 'Nunito', sans-serif; }
        .record-card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); background: #fff; margin-bottom: 20px; overflow: hidden; }
        .card-header-custom { background: #fff; border-bottom: 1px solid #f0f0f0; padding: 15px 20px; } /* æ‰‹æœºä¸Šç¨å¾®è°ƒå°padding */
        @media (min-width: 768px) { .card-header-custom { padding: 20px 25px; } }

        .form-label { font-weight: 600; color: #495057; font-size: 0.9rem; margin-bottom: 8px; }
        .input-group-text { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; }
        .form-control:focus { box-shadow: none; border-color: #11998e; }
        .history-item { border-left: 4px solid transparent; transition: all 0.2s; position: relative; }
        .history-item:hover { background-color: #f8f9fa; border-left-color: #11998e; transform: translateX(5px); }
        .history-item .btn-group-action { opacity: 0; transition: 0.2s; }
        .history-item:hover .btn-group-action { opacity: 1; }
        /* æ‰‹æœºç«¯å§‹ç»ˆæ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼Œæ–¹ä¾¿è§¦æ‘¸ */
        @media (max-width: 768px) { .history-item .btn-group-action { opacity: 1; } }

        .badge-date { background-color: #e3f2fd; color: #0d6efd; font-weight: bold; }
        .btn-sync { background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; color: white; font-weight: bold; }
        .btn-save-create { background: linear-gradient(45deg, #11998e, #38ef7d); border: none; }
        .btn-save-edit { background: linear-gradient(45deg, #f093fb, #f5576c); border: none; }
        .btn-save:hover { opacity: 0.9; transform: translateY(-1px); }
        .bmi-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary d-none d-md-block" href="{{ url_for('main.dashboard') }}">
            <i class="bi bi-chevron-left me-2"></i>è¿”å›ä»ªè¡¨ç›˜
        </a>
        <span class="navbar-brand fw-bold text-primary d-md-none">
            ğŸ“ æ¯æ—¥æ‰“å¡
        </span>

        <span class="navbar-text fw-bold text-dark d-none d-md-block">ğŸ“ æ¯æ—¥æ‰“å¡</span>
    </div>
</nav>

<div class="container pb-5">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-4">
        {% for message in messages %}
          <div class="alert alert-info alert-dismissible fade show shadow-sm border-0 rounded-3" role="alert">
            <i class="bi bi-bell-fill me-2"></i> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-lg-8">
            <div class="record-card border-top border-4 {% if edit_record %}border-warning{% else %}border-success{% endif %}">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <div>
                        {% if edit_record %}
                            <h5 class="m-0 fw-bold text-dark"><i class="bi bi-pencil-square text-warning me-2"></i>ç¼–è¾‘</h5>
                            <small class="text-muted d-none d-sm-inline">æ­£åœ¨ä¿®æ”¹ {{ edit_record.date }}</small>
                        {% else %}
                            <h5 class="m-0 fw-bold text-dark"><i class="bi bi-plus-circle text-success me-2"></i>æ–°æ•°æ®</h5>
                        {% endif %}
                    </div>

                    {% if not edit_record %}
                    <div>
                        <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                        <button type="button" class="btn btn-sm btn-sync rounded-pill px-3 py-2 shadow-sm" onclick="document.getElementById('importFile').click()">
                            <i class="bi bi-upload me-1"></i> <span class="d-none d-sm-inline">å¯¼å…¥ CSV</span>
                        </button>
                    </div>
                    {% else %}
                    <a href="{{ url_for('record.index') }}" class="btn btn-sm btn-light border rounded-pill text-muted"><i class="bi bi-x-lg"></i> å–æ¶ˆ</a>
                    {% endif %}
                </div>

                <div class="card-body p-3 p-md-4">
                    <form method="POST" action="{{ url_for('record.update', record_id=edit_record.id) if edit_record else url_for('record.index') }}">

                        <h6 class="text-muted small fw-bold mb-3 text-uppercase ls-1">ğŸƒ åŸºç¡€æ•°æ®</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3">
                                <label class="form-label">æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="date" name="date" required value="{{ edit_record.date if edit_record else '' }}">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">ä½“é‡ (kg) *</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-speedometer2"></i></span>
                                    <input type="number" step="0.1" min="20" max="300" class="form-control" id="weight" name="weight" placeholder="è¯·è¾“å…¥" value="{{ edit_record.weight if edit_record else '' }}" required>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">ä½“è„‚ç‡ (%)</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-pie-chart"></i></span>
                                    <input type="number" step="0.1" min="3" max="60" class="form-control" id="body_fat" name="body_fat" placeholder="é€‰å¡«" value="{{ edit_record.body_fat if edit_record and edit_record.body_fat else '' }}">
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">æ­¥æ•°</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-footprint"></i></span>
                                    <input type="number" min="0" max="100000" class="form-control" id="steps" name="steps" placeholder="è¯·è¾“å…¥" value="{{ edit_record.steps if edit_record else '' }}">
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted small fw-bold mb-3 text-uppercase ls-1 border-top pt-3">ğŸ’§ ä»£è°¢ä¸æ¶ˆè€—</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3">
                                <label class="form-label">é¥®æ°´ (ml)</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-cup-straw"></i></span>
                                    <input type="number" min="0" max="10000" class="form-control" id="water_intake" name="water_intake" placeholder="é€‰å¡«" value="{{ edit_record.water_intake if edit_record and edit_record.water_intake else '' }}">
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">å¡è·¯é‡Œ</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-fire"></i></span>
                                    <input type="number" min="0" max="10000" class="form-control" id="calories" name="calories" placeholder="è¯·è¾“å…¥" value="{{ edit_record.calories if edit_record else '' }}">
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">è¡€ç³–</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-droplet"></i></span>
                                    <input type="number" step="0.1" min="2" max="30" class="form-control" id="blood_glucose" name="blood_glucose" placeholder="é€‰å¡«" value="{{ edit_record.blood_glucose if edit_record and edit_record.blood_glucose else '' }}">
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">ç¡çœ  (h)</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-moon-stars"></i></span>
                                    <input type="number" step="0.1" min="0" max="24" class="form-control" id="sleep_hours" name="sleep_hours" placeholder="é€‰å¡«" value="{{ edit_record.sleep_hours if edit_record and edit_record.sleep_hours else '' }}">
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted small fw-bold mb-3 text-uppercase ls-1 border-top pt-3">ğŸ©º å¤‡æ³¨ä¿¡æ¯</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-4">
                                <label class="form-label">é™æ¯å¿ƒç‡</label>
                                <div class="input-group">
                                    <span class="input-group-text px-2"><i class="bi bi-heart-pulse"></i></span>
                                    <input type="number" min="30" max="250" class="form-control" id="heart_rate" name="heart_rate" placeholder="é€‰å¡«" value="{{ edit_record.heart_rate if edit_record and edit_record.heart_rate else '' }}">
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label">è¡€å‹ (é«˜/ä½)</label>
                                <div class="input-group">
                                    <input type="number" min="60" max="250" class="form-control" id="blood_pressure_high" name="bp_high" placeholder="é«˜å‹" value="{{ edit_record.blood_pressure_high if edit_record and edit_record.blood_pressure_high else '' }}">
                                    <span class="input-group-text px-1">/</span>
                                    <input type="number" min="40" max="150" class="form-control" id="blood_pressure_low" name="bp_low" placeholder="ä½å‹" value="{{ edit_record.blood_pressure_low if edit_record and edit_record.blood_pressure_low else '' }}">
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">å¤‡æ³¨</label>
                                <input type="text" class="form-control" id="note" name="note" placeholder="èº«ä½“æ„Ÿå—..." value="{{ edit_record.note if edit_record else '' }}">
                            </div>
                        </div>

                        {% if edit_record %}
                        <button type="submit" class="btn btn-save btn-save-edit w-100 shadow text-white fw-bold py-2 rounded-3"><i class="bi bi-check-circle-fill me-2"></i>ä¿å­˜ä¿®æ”¹</button>
                        {% else %}
                        <button type="submit" class="btn btn-save btn-save-create w-100 shadow text-white fw-bold py-2 rounded-3"><i class="bi bi-plus-lg me-2"></i>ä¿å­˜è®°å½•</button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="record-card h-100">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-secondary">ğŸ“‚ å†å²å½’æ¡£</h6>
                    <a href="{{ url_for('record.export') }}" class="btn btn-sm btn-outline-success rounded-pill px-3 fw-bold" title="ä¸‹è½½æ‰€æœ‰æ•°æ®"><i class="bi bi-download me-1"></i> <span class="d-none d-sm-inline">å¯¼å‡º</span></a>
                </div>
                <div class="list-group list-group-flush" style="max-height: 700px; overflow-y: auto;">
                    {% for record in records %}
                    <div class="list-group-item history-item p-3 border-0 border-bottom {% if edit_record and edit_record.id == record.id %}bg-warning bg-opacity-10 border-start border-4 border-warning{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge badge-date rounded-pill px-3">{{ record.date }}</span>
                            <div class="btn-group-action">
                                <a href="{{ url_for('record.edit_view', record_id=record.id) }}" class="text-primary me-2" title="ç¼–è¾‘" style="text-decoration: none;"><i class="bi bi-pencil-square"></i></a>
                                <a href="{{ url_for('record.delete', record_id=record.id) }}" class="text-danger" onclick="return confirm('âš ï¸ ç¡®å®šåˆ é™¤ï¼Ÿ')" title="åˆ é™¤"><i class="bi bi-trash"></i></a>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold text-dark fs-5">{{ record.weight }}</span> <small class="text-muted">kg</small>

                                {% if user.height and record.weight %}
                                    {% set h_m = user.height / 100 %}
                                    {% set bmi = record.weight / (h_m * h_m) %}
                                    {% if bmi < 18.5 %}
                                        <span class="bmi-badge bg-info text-white">åç˜¦</span>
                                    {% elif bmi > 24 %}
                                        <span class="bmi-badge bg-warning text-dark">è¶…é‡</span>
                                    {% else %}
                                        <span class="bmi-badge bg-success text-white">æ ‡å‡†</span>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <div class="text-end">
                                {% if record.blood_glucose %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 me-1">ç³– {{ record.blood_glucose }}</span>
                                {% endif %}
                                <small class="text-muted">{{ record.steps }} æ­¥</small>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 mb-2 d-block opacity-50"></i>æš‚æ— è®°å½•</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="mobile-bottom-nav d-md-none">
    <a href="{{ url_for('main.dashboard') }}" class="mobile-nav-item {{ 'active' if request.endpoint == 'main.dashboard' }}">
        <i class="bi bi-speedometer2"></i>é¦–é¡µ
    </a>
    <a href="{{ url_for('plan.index') }}" class="mobile-nav-item {{ 'active' if request.endpoint == 'plan.index' }}">
        <i class="bi bi-robot"></i>é¡¾é—®
    </a>
    <a href="{{ url_for('record.index') }}" class="mobile-nav-item mobile-nav-item-add active">
        <i class="bi bi-plus-circle-fill"></i>
    </a>
    <a href="{{ url_for('community.index') }}" class="mobile-nav-item {{ 'active' if request.endpoint == 'community.index' }}">
        <i class="bi bi-chat-heart"></i>ç¤¾åŒº
    </a>
    <a href="{{ url_for('user.settings') }}" class="mobile-nav-item {{ 'active' if request.endpoint == 'user.settings' }}">
        <i class="bi bi-person-circle"></i>æˆ‘çš„
    </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    {% if not edit_record %}
    if(document.getElementById('date')) { document.getElementById('date').valueAsDate = new Date(); }
    {% endif %}

    // è¡¨å•æäº¤å‰çš„é¢å¤–éªŒè¯
    document.querySelector('form').addEventListener('submit', function(e) {
        const bpHigh = document.getElementById('blood_pressure_high').value;
        const bpLow = document.getElementById('blood_pressure_low').value;
        
        // éªŒè¯è¡€å‹é€»è¾‘ï¼šå¦‚æœä¸¤ä¸ªéƒ½å¡«äº†ï¼Œé«˜å‹å¿…é¡»å¤§äºä½å‹
        if (bpHigh && bpLow) {
            if (parseInt(bpHigh) <= parseInt(bpLow)) {
                e.preventDefault();
                alert('è¾“å…¥æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ï¼šé«˜å‹å¿…é¡»å¤§äºä½å‹');
                return false;
            }
        }
        
        return true;
    });

    function handleFileUpload(input) {
        if (input.files.length === 0) return;
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        const btn = document.querySelector('.btn-sync');
        const originalContent = '<i class="bi bi-upload me-1"></i> <span class="d-none d-sm-inline">å¯¼å…¥ CSV</span>';
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> è§£æä¸­...';
        btn.disabled = true;

        fetch('/api/upload_data', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                const data = result.data;
                // è‡ªåŠ¨å›å¡«
                const fields = ['date', 'weight', 'steps', 'calories', 'sleep_hours', 'heart_rate', 'blood_pressure_high', 'blood_pressure_low', 'note', 'body_fat', 'water_intake', 'blood_glucose'];
                fields.forEach(id => {
                    if(data[id] && document.getElementById(id)) document.getElementById(id).value = data[id];
                });

                btn.classList.remove('btn-sync'); btn.classList.add('btn-success');
                btn.innerHTML = '<i class="bi bi-check-lg"></i> æˆåŠŸ';
                setTimeout(() => { btn.innerHTML = originalContent; btn.classList.remove('btn-success'); btn.classList.add('btn-sync'); btn.disabled = false; input.value = ''; }, 2000);
            } else { alert('å¤±è´¥ï¼š' + result.message); btn.innerHTML = originalContent; btn.disabled = false; }
        })
        .catch(error => { console.error(error); alert('ç½‘ç»œé”™è¯¯'); btn.innerHTML = originalContent; btn.disabled = false; });
    }
</script>
</body>
</html>