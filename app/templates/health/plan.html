<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¥åº·é¡¾é—® - Health Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* === å¸ƒå±€åŸºç¡€ === */
        body {
            background-color: #f0f2f5;
            font-family: 'Nunito', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
        }

        /* === é¡¶éƒ¨å¯¼èˆª === */
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
            z-index: 1000;
        }

        /* === èŠå¤©å†…å®¹åŒº === */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ—¶å‚ç›´æ»šåŠ¨ */
            padding: 20px;
            padding-bottom: 100px; /* ç•™å‡ºåº•éƒ¨è¾“å…¥æ¡†çš„ç©ºé—´ */
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #ced4da; border-radius: 10px; }

        /* === æ¶ˆæ¯æ°”æ³¡ === */
        .message-wrapper {
            display: flex;
            align-items: flex-start;
            max-width: 85%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI æ¶ˆæ¯ (å·¦ä¾§) */
        .message-ai {
            margin-right: auto;
        }
        .ai-avatar {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            margin-right: 12px;
            box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
            flex-shrink: 0;
        }
        .bubble-ai {
            background-color: #fff;
            color: #333;
            padding: 15px 20px;
            border-radius: 0 18px 18px 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ (å³ä¾§) */
        .message-user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        .user-avatar {
            width: 40px; height: 40px;
            background: #11998e;
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            margin-left: 12px;
            box-shadow: 0 4px 10px rgba(17, 153, 142, 0.3);
            flex-shrink: 0;
        }
        .bubble-user {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 12px 20px;
            border-radius: 18px 0 18px 18px;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.2);
            font-size: 0.95rem;
        }

        /* Markdown æ ·å¼ä¿®æ­£ */
        .bubble-ai p { margin-bottom: 0.5rem; }
        .bubble-ai p:last-child { margin-bottom: 0; }
        .bubble-ai ul, .bubble-ai ol { padding-left: 20px; margin-bottom: 0.5rem; }
        .bubble-ai strong { color: #d63031; background-color: #fff5f5; padding: 0 4px; border-radius: 4px; }
        .bubble-ai h1, .bubble-ai h2, .bubble-ai h3 { font-size: 1.1rem; font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #2c3e50; }

        /* === åº•éƒ¨è¾“å…¥åŒº === */
        .input-area {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background-color: #fff;
            padding: 15px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .input-wrapper {
            background-color: #f8f9fa;
            border-radius: 30px;
            padding: 5px 10px 5px 20px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }
        .input-wrapper:focus-within {
            background-color: #fff;
            border-color: #11998e;
            box-shadow: 0 0 0 4px rgba(17, 153, 142, 0.1);
        }
        .form-control-chat {
            border: none;
            background: transparent;
            box-shadow: none;
            font-size: 1rem;
            padding: 10px 0;
        }
        .form-control-chat:focus { box-shadow: none; background: transparent; }
        .btn-send {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            color: white;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .btn-send:hover { transform: scale(1.1); }
        .btn-send:disabled { background: #e9ecef; color: #adb5bd; transform: none; }

        /* === Loading åŠ¨ç”» === */
        .typing-indicator span {
            display: inline-block; width: 6px; height: 6px; background-color: #adb5bd; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both; margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="{{ url_for('main.dashboard') }}">
            <i class="bi bi-chevron-left me-2"></i>è¿”å›ä»ªè¡¨ç›˜
        </a>
        <div class="d-flex align-items-center">
            <span class="fw-bold text-dark me-2">ğŸ¤– ç§äººå¥åº·æ•™ç»ƒ</span>
            <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2">åœ¨çº¿</span>
        </div>
    </div>
</nav>

<div class="container chat-container" id="chat-box">
    <div class="message-wrapper message-ai">
        <div class="ai-avatar"><i class="bi bi-robot"></i></div>
        <div class="bubble-ai">
            ğŸ‘‹ ä½ å¥½ï¼Œ<strong>{{ nickname }}</strong>ï¼<br>
            æˆ‘æ˜¯æ‚¨çš„ä¸“å± AI å¥åº·é¡¾é—®ã€‚æˆ‘å·²ç»è¯»å–äº†æ‚¨çš„æœ€æ–°ä½“å¾æ•°æ®ã€‚<br><br>
            æ‚¨å¯ä»¥é—®æˆ‘ï¼š<br>
            ğŸ¯ <em>â€œæ ¹æ®æˆ‘çš„ä½“è„‚ç‡ï¼Œæ€ä¹ˆå®‰æ’å‡è„‚é¥®é£Ÿï¼Ÿâ€</em><br>
            ğŸƒ <em>â€œåˆ¶å®šä¸€ä¸ªé€‚åˆæˆ‘çš„æœ¬å‘¨è¿åŠ¨è®¡åˆ’â€</em><br>
            ğŸ¥— <em>â€œè¡€ç³–æœ‰ç‚¹é«˜ï¼Œæ—©é¤è¯¥åƒä»€ä¹ˆï¼Ÿâ€</em>
        </div>
    </div>
</div>

<div class="input-area">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="input-wrapper">
                    <input type="text" id="user-input" class="form-control form-control-chat" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off" onkeypress="handleEnter(event)">
                    <button class="btn btn-send ms-2" onclick="sendMessage()" id="send-btn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted" style="font-size: 0.75rem;">AI å°†ç»“åˆæ‚¨çš„èº«é«˜ã€ä½“é‡ã€ä½“è„‚ç‡ç­‰æ•°æ®è¿›è¡Œåˆ†æ</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // ç›‘å¬å›è½¦é”®
    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    // æ ¸å¿ƒå‘é€å‡½æ•°
    function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. ç¦ç”¨æŒ‰é’®
        sendBtn.disabled = true;
        userInput.disabled = true;

        // 2. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', text);
        userInput.value = '';

        // 3. æ˜¾ç¤º AI æ­£åœ¨è¾“å…¥...
        const loadingId = appendLoading();

        // 4. å‘é€è¯·æ±‚ç»™åç«¯
        fetch('/plan/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        })
        .then(res => res.json())
        .then(data => {
            removeLoading(loadingId); // ç§»é™¤ Loading

            if (data.status === 'success') {
                appendMessage('ai', data.reply);

                // å¦‚æœåç«¯è¯´æ›´æ–°äº†è®¡åˆ’ï¼Œç»™ä¸ªå°æç¤º
                if (data.updated_plan) {
                    showToast('âœ… æ¯æ—¥æ¸…å•å·²åŒæ­¥åˆ°ä»ªè¡¨ç›˜');
                }
            } else {
                appendMessage('ai', 'ğŸš« ' + data.reply);
            }
        })
        .catch(err => {
            console.error(err);
            removeLoading(loadingId);
            appendMessage('ai', 'âŒ ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ã€‚');
        })
        .finally(() => {
            // æ¢å¤è¾“å…¥æ¡†
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        });
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function appendMessage(role, text) {
        const wrapper = document.createElement('div');

        if (role === 'ai') {
            wrapper.className = 'message-wrapper message-ai';
            // AI æ¶ˆæ¯æ”¯æŒ Markdown
            const parsedText = marked.parse(text);
            wrapper.innerHTML = `
                <div class="ai-avatar"><i class="bi bi-robot"></i></div>
                <div class="bubble-ai">${parsedText}</div>
            `;
        } else {
            wrapper.className = 'message-wrapper message-user';
            wrapper.innerHTML = `
                <div class="user-avatar"><i class="bi bi-person-fill"></i></div>
                <div class="bubble-user">${text}</div>
            `;
        }

        chatBox.appendChild(wrapper);
        scrollToBottom();
    }

    // æ·»åŠ  Loading åŠ¨ç”»
    function appendLoading() {
        const id = 'loading-' + Date.now();
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper message-ai';
        wrapper.id = id;
        wrapper.innerHTML = `
            <div class="ai-avatar"><i class="bi bi-robot"></i></div>
            <div class="bubble-ai">
                <div class="typing-indicator"><span></span><span></span><span></span></div>
            </div>
        `;
        chatBox.appendChild(wrapper);
        scrollToBottom();
        return id;
    }

    function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function scrollToBottom() {
        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        chatBox.scrollTo({
            top: chatBox.scrollHeight,
            behavior: 'smooth'
        });
    }

    // ç®€å•çš„ Toast æç¤º
    function showToast(msg) {
        // è¿™é‡Œç®€å•ç”¨ alert ä»£æ›¿ï¼Œä¸ºäº†ç¾è§‚å¯ä»¥å¼•å…¥ Bootstrap Toast
        // æˆ–è€…ç›´æ¥åœ¨ console è¾“å‡º
        console.log(msg);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>